set dotenv-load := true

# List available commands
default:
    @just --list

# Start LocalStack container
start-localstack: stop-localstack
    @echo "Starting LocalStack..."
    docker run -d \
    --name localstack \
    --network host \
    -e SERVICES=sqs \
    -e DEFAULT_REGION=us-west-2 \
    -e AWS_ACCESS_KEY_ID=test \
    -e AWS_SECRET_ACCESS_KEY=test \
    localstack/localstack:latest
    @echo "Waiting for LocalStack to be ready..."
    @echo "LocalStack should be ready now"

# Stop LocalStack container
stop-localstack:
    @echo "Stopping any existing LocalStack containers..."
    docker stop localstack >/dev/null 2>&1 || true
    docker rm localstack >/dev/null 2>&1 || true
    @# Clean up any stray containers that might be using port 4566
    docker ps -q --filter publish=4566 | xargs -r docker stop >/dev/null 2>&1 || true
    @echo "Cleanup complete"

# Create SQS queue in LocalStack
create-queue:
    @echo "Creating test queue..."
    aws --endpoint-url=http://localhost:4566 sqs create-queue --queue-name test-queue || { echo "Failed to create queue. Is LocalStack running?"; exit 1; }

# List SQS queues in LocalStack
list-queues:
    aws --endpoint-url=http://localhost:4566 sqs list-queues

# Send a test message to the queue
send-message:
    aws --endpoint-url=http://localhost:4566 sqs send-message \
    --queue-url http://localhost:4566/000000000000/test-queue \
    --message-body "Test message from AWS CLI"

# Receive messages from the queue
receive-messages:
    aws --endpoint-url=http://localhost:4566 sqs receive-message \
    --queue-url http://localhost:4566/000000000000/test-queue \
    --max-number-of-messages 10 \
    --attribute-names All \
    --message-attribute-names All

# Delete a specific message from the queue using its receipt handle
delete-message:
    #!/usr/bin/env sh
    echo "Enter the receipt handle:"
    read RECEIPT_HANDLE
    aws --endpoint-url=http://localhost:4566 sqs delete-message \
    --queue-url http://localhost:4566/000000000000/test-queue \
    --receipt-handle "$RECEIPT_HANDLE"

# Build the .NET application
build:
    dotnet build

# Run the application
run:
    dotnet run --project Api/Api.csproj

# Run tests
test:
    dotnet test

# Clean build artifacts
clean:
    dotnet clean

# Setup everything and start the application
setup: stop-localstack start-localstack create-queue build
    @echo "LocalStack is running and queue is created"
    @echo "Starting the API..."
    just run
